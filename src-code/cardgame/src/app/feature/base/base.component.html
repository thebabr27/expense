<!-- Button trigger modal -->
<button #modalTrigger type="button" style="width: 0; position: absolute; height: 0; opacity: 0;" data-bs-toggle="modal"
    data-bs-target="#exampleModal"></button>

<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-body d-flex justify-content-around">
                <h5 class="modal-title" id="colorModalLabel">Scegli il colore:</h5>
                <button class="btn btn-danger color-btn" data-bs-dismiss="modal"
                    (click)="chooseColor('rosso')">Rosso</button>
                <button class="btn btn-warning color-btn" data-bs-dismiss="modal"
                    (click)="chooseColor('giallo')">Giallo</button>
                <button class="btn btn-blue color-btn" data-bs-dismiss="modal" (click)="chooseColor('blu')">Blu</button>
                <button class="btn btn-success color-btn" data-bs-dismiss="modal"
                    (click)="chooseColor('verde')">Verde</button>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary">Save changes</button>
            </div>
        </div>
    </div>
</div>
<div class="container-fluid pt-5 ">
    <!-- PLAYER INPUT -->
    <div *ngIf="gameForm.get('phase')?.value === 'player-input'"
        class="container d-flex justify-content-center player-input-container h-100 px-0">
        <div class="d-flex flex-column h-100 justify-content-center w-100 player-input-inner-container ">
            <input #nicknameInput [(ngModel)]="nickname" type="text" class="form-control" placeholder="Nickname"
                (keydown.enter)="addPlayer()">
            <button (click)="addPlayer()" class="mt-3 btn btn-primary w-100">Enter</button>
        </div>

    </div>

    <!-- WAITING ROOM -->
    <div *ngIf="gameForm.get('phase')?.value === 'waiting-room'"
        class="container d-flex justify-content-center align-items-center h-100">
        <div class="card w-100 waiting-room" style="max-width: 500px;">
            <div class="card-body text-center">
                <h5 class="card-title">Sala d'attesa</h5>
                <p class="text-light" *ngIf="(gameForm.get('users')?.value?.length || 0) < minPlayers">
                    In attesa di altri giocatori...
                </p>
                <p class="text-light" *ngIf="(gameForm.get('users')?.value?.length || 0) >= minPlayers">
                    Pronti per giocare
                </p>


                <!-- Lista giocatori -->
                <ul class="list-group list-group-flush mb-3">
                    <li *ngFor="let p of gameForm.get('users')?.value"
                        class="list-group-item d-flex align-items-center">
                        <!-- Nome giocatore -->
                        <span class="me-2">{{ p.name }}</span>

                        <!-- Icona + type -->
                        <span class="badge bg-secondary d-flex align-items-center">
                            <i *ngIf="p.playerType === 'human'" class="bi bi-person-fill me-1"></i>
                            <i *ngIf="p.playerType === 'cpu'" class="bi bi-pc-display-horizontal me-1"></i>
                            {{ p.playerType }}
                        </span>
                    </li>

                </ul>

                <!-- Pulsante Start (disabilitato finchÃ© non ci sono almeno 2 giocatori) -->
                <button (click)="startGame()" [disabled]="(gameForm.get('users')?.value?.length || 0) < minPlayers"
                    class="btn btn-primary w-100 mb-2">
                    Inizia la partita
                </button>

                <!-- Pulsante Gioca contro il computer -->
                <button *ngIf="gameForm.get('users')?.value.length < minPlayers" (click)="addBots()"
                    class="btn btn-primary w-100">
                    Gioca contro il computer
                </button>
            </div>
        </div>
    </div>

    <!-- USERS-WAITING-FOR-CARDS -->
    <div *ngIf="gameForm.get('phase')?.value === 'start-waiting' || gameForm.get('phase')?.value === 'start-playing'"
        class="container">
        <div class="position-absolute players-wrapper">
            <div class="d-flex flex-column">
                <!-- Cicla su tutti i giocatori tranne me -->
                <div *ngFor="let player of gameForm.get('users')?.value; let pi = index"
                    class="d-flex flex-column text-end me-1 mt-2">
                    <div *ngIf="player.name !== gameForm.get('userName')?.value" class="d-flex flex-column text-end">

                        <!-- Nome e numero di carte -->
                        <div class="d-flex align-items-center">
                            <div *ngIf="gameForm.get('peopleInTurn')?.value === player.name"
                                class="spinner-border spinner-border-sm mx-1 text-warning" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mb-1">{{ player.name }}</p>
                        </div>
                        <p class="mb-1">Carte {{ player.deck?.length || 0 }}</p>


                        <!-- Mini deck -->
                        <div class="mini-card-wrapper d-flex flex-column">
                            <div *ngFor="let card of player.deck" class="card mini-card me-1">
                                <div class="card-body"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


        </div>
        <div class="d-flex justify-content-between card-wrapper upper-deck-wrapper">
            <div class="left-wrapper">
                <div [class]="gameForm.get('gameName')?.value?.toLowerCase() +'-deck-card'"
                    class="card deck-card position-absolute  shadow"
                    (click)="playerDrawCard(gameForm.get('userName')?.value)">
                    <div class="card-body"> </div>
                </div>
            </div>
        </div>
        <div class="d-flex justify-content-between card-wrapper center-deck-wrapper">
            <div class="  d-md-none">

            </div>
            <div class="center-wrapper position-relative"
                [ngClass]="{'scopa-center-wrapper': gameForm.get('gameName')?.value?.toLowerCase() === 'scopa'}">
                <div class="deck-container" style="position: relative; "
                    [class]="gameForm.get('gameName')?.value?.toLowerCase() === 'scopa' ? 'position-absolute' : ''"
                    [ngStyle]="gameForm.get('gameName')?.value?.toLowerCase() === 'scopa' ? {} : {'margin-left': calculateMarginForDeckContainer(gameForm.get('centerDeck')?.value?.length)}">

                    <div *ngFor="let card of gameForm.get('centerDeck')?.value; let i = index"
                        class="card deck-card shadow" [ngClass]="getCardClasses(card)"
                        (click)="action('centerDeckCard', card)">
                        <div class="selected-card-icon d-none position-absolute">
                            <i class="bi bi-check-lg text-green"></i>
                        </div>
                        <div class="card-body w-100 d-flex flex-column justify-content-center align-items-center">
                            <h1 class="center-value m-0 center-icon-scopa" [ngClass]="getCardCenterClass(card)"></h1>
                        </div>

                    </div>

                </div>
            </div>


            <div class=" d-md-none"> </div>
        </div>
        <div class="d-flex justify-content-center card-wrapper" style="margin-top: 50px;">
            <div class="deck-container d-flex justify-content-center" style="position: relative; height: 135px;">

                <!-- [ngStyle]="{'margin-left': calculateMarginForDeckContainer(getMyUserDeck().length)}" -->
                <div *ngFor="let card of getMyUserDeck(); let i = index"
                    class="card deck-card position-absolute  shadow" [ngClass]="getCardClasses(card)" [ngStyle]="{
       'margin-left': calculateMargin(i, getMyUserDeck().length),
       'z-index': hoveredCard === card ? 100 : 1
     }" (mouseenter)="onHover(card)" (mouseleave)="onLeave()" (click)="action('userDeckCard', card)">

                    <div class="card-body w-100 d-flex flex-column justify-content-between">
                        <!-- Valore piccolo in alto a sinistra -->
                        <div class="d-flex justify-content-start">
                            <span *ngIf="!card.suit && card.type" class="small-value">
                                <div *ngIf="card.type == 'reverse'"><i class="bi bi-arrow-repeat"></i></div>
                                <div *ngIf="card.type == 'skip'"><i class="bi bi-x-circle"></i></div>
                                <div *ngIf="card.type == 'draw-two'"><i class="bi bi-plus-lg"></i>2</div>
                                <div *ngIf="card.type == 'wild-draw-four'"><i class="bi bi-plus-lg"></i>4</div>
                                <div *ngIf="card.type == 'wild'">
                                    <div class="change-color-icon"></div>
                                </div>
                                <div *ngIf="card.suit && card.type == 'Denari'">
                                    <div class="denari"></div>
                                </div>
                                <div *ngIf="card.suit && card.type == 'Spade'">
                                    <div class="spade"></div>
                                </div>
                                <div *ngIf="card.suit && card.type == 'Bastoni'">
                                    <div class="bastoni"></div>
                                </div>
                                <div *ngIf="card.suit && card.type == 'Coppe'">
                                    <div class="coppe"></div>
                                </div>
                            </span>
                            <span *ngIf="!card.type" class="small-value">{{ card.value }}</span>
                        </div>

                        <!-- Valore grande al centro -->
                        <div class="d-flex justify-content-center align-items-center flex-grow-1">
                            <h1 class="center-value m-0 d-flex justify-content-center align-items-center">

                                <!-- Carte UNO -->
                                <ng-container *ngIf="gameForm.get('gameName')?.value === 'uno'">
                                    <!-- Carte speciali -->
                                    <i *ngIf="card.type === 'reverse'" class="bi bi-arrow-repeat"></i>
                                    <i *ngIf="card.type === 'skip'" class="bi bi-x-circle"></i>
                                    <span *ngIf="card.type === 'draw-two'" class="uno-number">2</span>
                                    <div *ngIf="card.type === 'wild-draw-four'" class="plus-four-icon center-icon">
                                    </div>
                                    <div *ngIf="card.type === 'wild'" class="change-color-icon center-icon"></div>

                                    <!-- Carte numeriche -->
                                    <span *ngIf="!card.type" class="uno-number">{{ card.value }}</span>
                                </ng-container>

                                <!-- Carte SCOPA -->
                                <ng-container
                                    *ngIf="gameForm.get('gameName')?.value === 'scopa' && card.suit && card.rank">
                                    <div [ngClass]="getCardCenterClass(card)" class="center-icon-scopa"></div>
                                </ng-container>

                            </h1>
                        </div>


                        <!-- Valore piccolo in basso a destra -->
                        <div *ngIf="!card.suit" class="d-flex justify-content-end">
                            <span *ngIf="card.type" class="small-value">
                                <div *ngIf="card.type == 'reverse'"><i class="bi bi-arrow-repeat"></i></div>
                                <div *ngIf="card.type == 'skip'"><i class="bi bi-x-circle"></i></div>
                                <div *ngIf="card.type == 'draw-two'"><i class="bi bi-plus-lg"></i>2</div>
                                <div *ngIf="card.type == 'wild-draw-four'"><i class="bi bi-plus-lg"></i>4</div>
                                <div *ngIf="card.type == 'wild'">
                                    <div class="change-color-icon"></div>
                                </div>
                            </span>
                            <span *ngIf="!card.type" class="small-value">{{ card.value }}</span>
                        </div>
                    </div>
                </div>

            </div>

        </div>
    </div>

    <!-- FINISH -->
    <div *ngIf="gameForm.get('phase')?.value === 'finish-playing'">
        <h2>Risultati finali</h2>

        <table class="table table-striped table-dark" border="1" cellpadding="6">
            <thead>
                <tr>
                    <th>Giocatore</th>
                    <th>Scope</th>
                    <th>Carte</th>
                    <th>Denari</th>
                    <th>Settebello</th>
                    <th>Primiera</th>
                    <th>Punteggio Totale</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let user of getUserScores()">
                    <td>{{ user.name }}</td>
                    <td>{{ user.scope }}</td>
                    <td>{{ user.carte }}</td>
                    <td>{{ user.denari }}</td>
                    <td>{{ user.settebello }}</td>
                    <td>{{ user.primiera }}</td>
                    <td><strong>{{ user.total }}</strong></td>
                </tr>
            </tbody>
        </table>
    </div>

</div>